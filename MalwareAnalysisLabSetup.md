```
                           (Internet)
                                ^
Virtualization Host             |
________________________________x_______________________
                                |
       ______________                  ______________
       |FlareVM     |                  |Remnux      |
       |Sandbox     |                  |Gateway     |
       |192.168.0.10|                  |192.168.0.2 |
       |____________|                  |____________|
      /            /                  /            /
     /____________/                  /____________/ 
```


# Lab Setup
1. Virtulization Host (Preference: Windows 10 running Hyper-V)
2. Windows VM running FlareVM
3. Ubuntu VM running Remnux

# Overview
The lab consist of a virtualization host, in my case, i'd prefer Hyper-V.

2 Virtual Machines are required.

1 Windows VM to be provisioned as FlareVM, using it as a sandbox to detonate malware, and perform static/dynamic analysis as well as debugging.

1 Ubuntu VM to be downloaded from Remnux, using it mainly as a gateway. It can also be used as an alternative environment to perform static analysis and debugging, depending on your preference. 

# Enable Hyper-V in Windows 10

Go to "Turn Windows features on or off", and enable "Hyper-V", a restart of the host might be required.
Note: You will need to enable VT Technology in the bios of your workstation if you are using Intel processor, or AMD-V if using AMD processor.

# Network Setup for Hyper-V

Open powershell with admin rights on the host.

Create an Internal virtual switch.
```
New-VMSwitch -SwitchName “vSwitch_InternalNAT” -SwitchType Internal
```

```Get-NetAdapter``` to confirm that the vSwitch has been created.

Next, assign an IP/subnet to the vSwitch, note this IP will be gateway IP.

```
New-NetIPAddress -IPAddress 192.168.0.1 -PrefixLength 24 -InterfaceAlias "vSwitch_InternalNAT"
```

``` Get-NetIPAddress``` to check of IP at the interfaces of the host.

# Enable/remove a vSwitch with NAT - for internet connection

Create a new NAT for the CIDR allowed for internet connection. 
```
New-NetNAT -Name "NATNetwork" -InternalIPInterfaceAddressPrefix 192.168.0.0/24
```

```Get-NetNat``` to see if that NAT settings are up.

To remove the NAT:
```
Remove-NetNat -Name NATNetwork
```

# Optional update of Windows host

I'll recommend not to run any patch against the Windows image you are provisioning with, unless there is a need to update (e.g testing of CVEs against some Windows Component). Depending on the nature of the malware, it might not be able to run successfully if a vulnerabilities has been patched; this would greatly affect the results of dynamic analysis and debugging.

# Setup FlareVM
Specs: 40GB disk space, 4Gb RAM, 1 vCPU/1 core (the more the better)

Most malwares are written for windows, thus it is most favorable to perform analysis on a windows, coupled with a network interface so the malware (with network capabilities) can traverse through a NIC.

We will require internet connection here. Set the VM with the following network configuration or a configuration of your choice:
```
IP Address: 192.168.0.10
Subnet: 255.255.255.0
Gateway: 192.168.0.1
DNS: 8.8.8.8
```

Follow the instructions [here](https://github.com/fireeye/flare-vm#windows-10-installation) to provision the windows into flareVM.

# Install additional tools on FlareVM

Most of the tools required for malware analysis are already prebuilt, however there are some tools which I personally preferred.

1. [Burp Suite (Community)](https://portswigger.net/burp/communitydownload)

This is mostly used to act as a proxy server to inspect http/s traffic, and capture the request headers and data in the request/response. This is preferred over wireshark/fiddler as it can intercept network request/response.

2. Microsoft Office

VBA Macro requires MS Office to execute the payload. This is needed in time when the analyst hits a roadblock in his static analysis and has to rely on dynamic analysis.

3. [runsc](https://github.com/edygert/runsc)

Used to emulate shellcode for dynamic analysis in the isolated lab.

4. [WinDump](https://www.winpcap.org/windump/install/default.htm)

Component needed to run ProcDOT

# Extra configurations on FlareVM

1. Procmon

To enable its output to work well with ProcDOT, pls read the readme.txt provided in ProcDOT, otherwise, refer to the following:
- disable (uncheck) "Show Resolved Network Addresses" (Options)
- disable (uncheck) "Enable Advanced Output" (Filter)
- adjust the displayed columns (Options > Select Columns ...)
- to not show the "Sequence" column
- to show the "Thread ID" column

2. ProcDOT

During the first execution of ProcDOT, it will ask for the optional files path for windump and Graphviz
windump - Depends on where did you unzip the WinDump file 
Graphviz - it is available at _C:\ProgramData\chocolatey\bin\dot.exe_

# Setup Remnux
Specs: 20GB disk space, 2Gb RAM, 1 vCPU/1 core (the more the better, since it is a default ova, you will have to expand the disk space according)

Follow this [link](https://docs.remnux.org/install-distro/get-virtual-appliance) to download Remnux OVA, you will need [StarWind](https://www.starwindsoftware.com/starwind-v2v-converter#download) as well to convert the .ova into .vhdx so that it can be imported into the Hyper-V. Use [7z](https://www.7-zip.org/download.html) to open the downloaded .ova, to extract the .vmdk.gz file, re-extract again to obtain the .vmdk file. Now, use StarWind to convert Remnux image from .vmdk to .vhdx, and create a new VM in Hyper-V, using the converted .vhdx, you should be able to start the Remnux in Hyper-V.

We will require internet connection here. Set the VM with the following network configuration or a configuration of your choice:

```sudo vi /etc/netplan/01-netcfg.yaml```

```
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      dhcp4: no
      addresses:
        - 192.168.0.2/24
      gateway4: 192.168.0.1
      nameservers:
          addresses: [8.8.8.8, 8.8.4.4]
```

To apply, run ```sudo netplan apply```

```
set-static-ip 192.168.0.2
```

You may need to change IP if a malware targets a specific IP.


# Optional Update of Remnux

Run update with the command, reference [here](https://docs.remnux.org/install-distro/keep-the-distro-up-to-date), once again, this is not recommended unless there are any new tools unavailable.

```
remnux upgrade
remnux update
```

# Transfer content (clipboard text) between host and Remnux

Unfortunately Hypver-V doesn't support linux well natively, and there isn't sufficient materials at the time of writing that suggest we can perform a copy and paste (text and files) easily between the host and the Remnux VM. We have to rely on enabling xrdp in the linux, and perform a RDP from host to the Remnux to do copy and paste. 

For complete guide, pls read [this](https://www.starwindsoftware.com/blog/configuring-ubuntu-server-gui-remote-access-part-2-using-xrdp-server)

```
sudo apt install -y xrdp
sudo systemctl enable xrdp
```

Do note that you might have to rdp to the Remnux twice (the first will cause the hyper-v session to get logged out, the second will then allows you to establish a successful session.

# Transfer files between host and Remnux

Likewise, the best way to do this at the time of writing, will be to perform a [winscp](https://winscp.net/eng/download.php) to the VM and transfer file. Follow the below to setup/enable the SSH on Remnux:
```
sudo apt install openssh-server
sudo systemctl start ssh
sudo systemctl enable ssh
```

# Resetting the environment

This is quite the last step. First we will need to remove the Internet connectivity by removing the NAT.
```
Remove-NetNat -Name NATNetwork
```

Reset the Windows VM network configuration with the following:
```
IP Address: 192.168.0.10
Subnet: 255.255.255.0
Gateway: 192.168.0.2
DNS: 192.168.0.2
```

# Snapshot the VMs
Shutdown both VMs and perform a snapshot at the Hyper-V console.

# Reference

https://www.petri.com/using-nat-virtual-switch-hyper-v

https://github.com/fireeye/flare-vm

https://docs.remnux.org/install-distro/get-virtual-appliance

https://docs.remnux.org/install-distro/keep-the-distro-up-to-date

https://www.starwindsoftware.com/starwind-v2v-converter

https://www.starwindsoftware.com/blog/configuring-ubuntu-server-gui-remote-access-part-2-using-xrdp-server

https://github.com/edygert/runsc
